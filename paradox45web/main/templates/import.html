{% extends 'base.html' %}

{% block content %}
<h2>Import</h2>
<p>{{ msg }}</p>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="file">Choose file to upload:</label>
    <input type="file" id="file" name="file">
    <button type="submit">Upload</button>
</form>

<hr>
<h3>Import z webu</h3>
<form method="post" style="margin-bottom:10px">
    {% csrf_token %}
    <input type="url" name="web_url" placeholder="https://example.com/page-with-tables" value="{{ web_url|default:'' }}" style="width:60%">
    <button type="submit" name="fetch_web" value="1">Naƒç√≠st tabulky</button>
    <button type="submit" name="fetch_web_js" value="1">Naƒç√≠st (JS)</button>
</form>
{% if web_tables %}
    <p>Nalezeno tabulek: {{ web_tables|length }}</p>
    <table border="1" cellpadding="6" cellspacing="0" style="width:100%; background:#111; color:#EDEDED;">
        <thead>
            <tr>
                <th>#</th>
                <th>N√°hled</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
        {% for wt in web_tables %}
            <tr>
                <td style="white-space:nowrap">{{ forloop.counter0 }}</td>
                <td>
                    <div style="max-height:200px; overflow:auto; border:1px solid #444;">
                        {{ wt.preview|safe }}
                    </div>
                </td>
                <td style="min-width:240px">
                    <form method="post" style="display:flex; gap:6px; align-items:center;">
                        {% csrf_token %}
                        <input type="hidden" name="web_url" value="{{ web_url }}">
                        <input type="hidden" name="import_web_index" value="{{ forloop.counter0 }}">
                        <input type="text" name="import_web_table" placeholder="N√°zev c√≠lov√© tabulky" value="{{ wt.suggest }}">
                        <button type="submit" name="import_web" value="1">Importovat</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% elif web_url %}
    <p>Nebyly nalezeny ≈æ√°dn√© tabulky na adrese: {{ web_url }}</p>
{% endif %}

<hr>
<h3>Imported files</h3>
{% if imported_files %}
<table border="1" cellpadding="6" cellspacing="0">
    <thead>
        <tr>
            <th>Name</th>
            <th>Size (KB)</th>
            <th>Modified</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for f in imported_files %}
        <tr>
            <td>{{ f.name }}</td>
            <td style="text-align:right">{{ f.size_kb }}</td>
            <td>{{ f.mtime }}</td>
            <td>
                <!-- Convert form: pou≈æ√≠v√° button typu button a JS prompt pro zad√°n√≠ jm√©na tabulky -->
                <form method="post" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="convert_file" value="{{ f.name }}">
                    <input type="hidden" name="convert_table" value="">
                    <button type="button" title="Convert (CSV/JSON)" style="background:none;border:none;cursor:pointer;color:#070;font-size:16px;margin-right:6px" onclick="return convertPrompt(this.form, '{{ f.name|escapejs }}');">üîÅ</button>
                </form>

                <!-- Delete form: potvrzen√≠ p≈ôes onclick -->
                <form method="post" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="delete_file" value="{{ f.name }}">
                    <button type="submit" title="Delete" style="background:none;border:none;cursor:pointer;color:#c00;font-size:16px" onclick="return confirm('Delete file &quot;{{ f.name|escapejs }}&quot;? This action cannot be undone.');">üóë</button>
                </form>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No imported files found.</p>
{% endif %}

<script>
function convertPrompt(form, fname) {
    // suggested table name = filename without extension
    var suggested = fname.replace(/\.[^/.]+$/, '');
    var tbl = prompt('Enter table name (leave empty to use "' + suggested + '"):', suggested);
    if (tbl === null) { // user cancelled
        return false;
    }
    // set hidden input
    if (form.elements['convert_table']) {
        form.elements['convert_table'].value = tbl.trim();
    }
    var target = form.elements['convert_table'] && form.elements['convert_table'].value ? form.elements['convert_table'].value : suggested;
    if (!confirm('Convert file "' + fname + '" into table "' + target + '"?')) {
        return false;
    }
    form.submit();
    return false;
}
</script>

{% endblock %}
