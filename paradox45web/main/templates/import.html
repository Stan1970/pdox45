{% extends 'base.html' %}

{% block content %}
<h2>Import</h2>
<p>{{ msg }}</p>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <label for="file">Choose file to upload:</label>
    <input type="file" id="file" name="file">
    <button type="submit">Upload</button>
</form>

<hr>
<h3>Import z webu</h3>
<form method="post" style="margin-bottom:10px">
    {% csrf_token %}
    <input type="url" name="web_url" placeholder="https://example.com/page-with-tables" value="{{ web_url|default:'' }}" style="width:60%">
    <button type="submit" name="fetch_web" value="1">Načíst tabulky</button>
    <button type="submit" name="fetch_web_js" value="1">Načíst (JS)</button>
</form>
{% if web_tables %}
    <p>Nalezeno tabulek: {{ web_tables|length }}</p>
    <table border="1" cellpadding="6" cellspacing="0" style="width:100%; background:#111; color:#EDEDED;">
        <thead>
            <tr>
                <th>#</th>
                <th>Náhled</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
        {% for wt in web_tables %}
            <tr>
                <td style="white-space:nowrap">{{ forloop.counter0 }}</td>
                <td>
                    <div style="max-height:200px; overflow:auto; border:1px solid #444;">
                        {{ wt.preview|safe }}
                    </div>
                </td>
                <td style="min-width:240px">
                    <form method="post" style="display:flex; gap:6px; align-items:center;">
                        {% csrf_token %}
                        <input type="hidden" name="web_url" value="{{ web_url }}">
                        <input type="hidden" name="import_web_index" value="{{ forloop.counter0 }}">
                        <input type="text" name="import_web_table" placeholder="Název cílové tabulky" value="{{ wt.suggest }}">
                        <button type="submit" name="import_web" value="1">Importovat</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% elif web_url %}
    <p>Nebyly nalezeny žádné tabulky na adrese: {{ web_url }}</p>
{% endif %}

<hr>
<h3>Import z OTE (API / přímé tabulky)</h3>
<form method="post" style="margin-bottom:10px">
    {% csrf_token %}
    <label>Datum:</label>
    <input type="date" name="ote_date" value="{{ ote_date|default:'' }}">
    <label>Time resolution:</label>
    <select name="ote_time_resolution">
        <option value="PT15M" {% if ote_time_resolution == 'PT15M' %}selected{% endif %}>PT15M</option>
        <option value="PT60M" {% if ote_time_resolution == 'PT60M' %}selected{% endif %}>PT60M</option>
    </select>
    <button type="submit" name="fetch_ote" value="1">Načíst OTE</button>
</form>
{% if ote_tables %}
    <p>Nalezeno OTE tabulek: {{ ote_tables|length }} (URL: {{ ote_url }})</p>
    <table border="1" cellpadding="6" cellspacing="0" style="width:100%; background:#111; color:#EDEDED;">
        <thead><tr><th>#</th><th>Náhled</th><th>Akce</th></tr></thead>
        <tbody>
        {% for ot in ote_tables %}
            <tr>
                <td>{{ forloop.counter0 }}</td>
                <td><div style="max-height:200px; overflow:auto; border:1px solid #444;">{{ ot.preview|safe }}</div></td>
                <td>
                    <form method="post" style="display:flex; gap:6px; align-items:center;">
                        {% csrf_token %}
                        <input type="hidden" name="ote_date" value="{{ ote_date }}">
                        <input type="hidden" name="ote_time_resolution" value="{{ ote_time_resolution }}">
                        <input type="hidden" name="import_ote_index" value="{{ forloop.counter0 }}">
                        <input type="text" name="import_ote_table" placeholder="Název tabulky" value="{{ ot.suggest }}">
                        <button type="submit" name="import_ote" value="1">Importovat</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% elif ote_date %}
    <p>Žádné OTE tabulky pro datum {{ ote_date }}.</p>
{% endif %}

<hr>
<h3>Log posledních importů</h3>
{% if import_logs %}
<table border="1" cellpadding="6" cellspacing="0" style="width:100%; background:#111; color:#EDEDED;">
  <thead><tr><th>Čas</th><th>Zdroj</th><th>Typ</th><th>Tabulka</th><th>Řádků</th><th>Sloupců</th></tr></thead>
  <tbody>
  {% for log in import_logs %}
    <tr>
      <td>{{ log.imported_at }}</td>
      <td style="word-break:break-all">{{ log.source }}</td>
      <td>{{ log.source_type }}</td>
      <td>{{ log.table_name }}</td>
      <td style="text-align:right">{{ log.rows }}</td>
      <td style="text-align:right">{{ log.cols }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p>Žádné záznamy v logu.</p>
{% endif %}

<script>
function convertPrompt(form, fname) {
    // suggested table name = filename without extension
    var suggested = fname.replace(/\.[^/.]+$/, '');
    var tbl = prompt('Enter table name (leave empty to use "' + suggested + '"):', suggested);
    if (tbl === null) { // user cancelled
        return false;
    }
    // set hidden input
    if (form.elements['convert_table']) {
        form.elements['convert_table'].value = tbl.trim();
    }
    var target = form.elements['convert_table'] && form.elements['convert_table'].value ? form.elements['convert_table'].value : suggested;
    if (!confirm('Convert file "' + fname + '" into table "' + target + '"?')) {
        return false;
    }
    form.submit();
    return false;
}
</script>

{% endblock %}
